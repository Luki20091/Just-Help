<!DOCTYPE html>
<html lang="pl">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Just Help | Wolontariusz</title>
	<meta name="description" content="Aplikacja internetowa - konkurs Hack Heroes 2022">
	<meta name="keywords" content="aktywista, charytatywność, charytatywny, dać komuś oparcie, dać oparcie, dla niepełnosprawnych, dla potrzebujących, dla seniorów, dla wolontariatu, dobre uczynki, dobrodziej, dobrowolny uczestnik, doby uczynek, doradztwo, działacz społeczny, e wolontariat, e-wolontariat, help, helpful, helpy, ideowiec, jak pomagać, jak pomoc ukrainie, jak pomóc, lekcje, obywatele, ochotnik, oparcie, oparcie, pobliska pomoc, podaj pomocną dłoń, podaj pomocną rękę, pomoc, pomoc 24/7, pomoc 24h, pomoc domowa, pomoc obywatelom, pomoc starszym, pomoc starszym osobom, pomoc ukrainie, pomoc w lekcjach, pomoc w prostych zadaniach, pomoc w zakupach, pomocny, potrzebujący, praca domowa, prace domowe, przyjacielska dłoń, przysługa, przysługi, senior, społeczna pomoc, społecznik, sąsiedzka pomoc, uczynek, uczynki, volunteer, wolontariat, wolontariat polska, wolontariusz, wpieranie, wsparcie, zadania społeczne, życzliwa dłoń">
	<meta name="author" content="Łukasz Kucharczyk, Oliwier Adamczyk, Piort Piskorz, Bartłomiej Pachniak">
	<meta name="copyright" content="Copyright Just Help - AT squad">

	<link rel="stylesheet" type="text/css" href="assets/styles/index.css">

	<script src="https://code.jquery.com/jquery-3.5.0.js"></script>
	<script src="https://kit.fontawesome.com/ac1b82ff7f.js" crossorigin="anonymous"></script>
</head>


<body>
	<div id="loader-wrapper">
		<div class="loader2"></div>
	</div>
	<div id="test">
		<h2>Testowe konto:</h2>
		<p>wolontariusz@test.test</p>
		<p>12345678</p>
	</div>
	<section id="menu" class="sections">
		<h1>Masz konto wolontariusza? - Czy jesteś tu nowy/a?</h1>
		<div class="chose-boxes">
			<div class="chose-box green login" id="log" tabindex="1">
				<div class="in-chose-box">
				</div>
				<h1>Logowanie</h1>
			</div>
			<div class="chose-box green register" id="reg" tabindex="2">
				<div class="in-chose-box">
				</div>
				<h1>Tworzenie konta</h1>
			</div>
		</div>
	</section>
	<section id="registerForm" class="sections">
		<form>
			<h1>Tworzenie konta wolontariusza</h1>
			<input type="text" id="register-username" placeholder="Nazwa użytkownika" autocomplete="off" spellcheck="false" tabindex="1">
			<input type="email" id="register-email" placeholder="Email" autocomplete="off" spellcheck="false" tabindex="2">
			<input type="password" id="register-password" placeholder="Hasło" autocomplete="off" spellcheck="false" tabindex="3">
			<input type="password" id="register-confirm-password" placeholder="Powtórz hasło" autocomplete="off" spellcheck="false" tabindex="4">
			<button type="button" id="register" tabindex="5"><i class="fa-solid fa-pencil"></i>&nbsp;Utwórz konto</button>
		</form>
	</section>
	<section id="loginForm" class="sections">
		<form>
			<h1>Logowanie wolontariusza</h1>
			<input type="email" id="login-email" placeholder="Email" autocomplete="off" spellcheck="false" tabindex="1">
			<input type="password" id="login-password" placeholder="Hasło" autocomplete="off" spellcheck="false" tabindex="2">
			<button type="button" id="login" tabindex="3"><i class="fa-solid fa-lock-open"></i>&nbsp;Zaloguj</button>
		</form>
	</section>
	<section id="profile" class="sections">
		<h1>Profil wolontariusza</h1>
		Nick: <div id="profile-username"><div class="loader"></div></div><br>
		Punkty: <div id="profile-points"><div class="loader"></div></div><br>
		Email: <div id="profile-email"><div class="loader"></div></div><br>
		Utworzono: <div id="profile-account-create"><div class="loader"></div></div><br>
		<button type="button" id="logout" tabindex="1"><i class="fa-solid fa-lock"></i>&nbsp;Wyloguj</button>
		<button type="button" onclick="location.href='#zlecenia'">Zlecenia</button>
		<button type="button" onclick="location.href='#aktywne-zlecenia'">Aktywne zlecenia</button>
		<!--<button type="button" onclick="location.href='#wymiana-punktow'">Wymiana punktów</button>  W przyszłości-->
		<button type="button" onclick="location.href='#topka'">Topka</button>
	</section>
	<section id="posts" class="sections">
		<h1 id="posts-h1"></h1>
		<div id="postsList">
			<div class="loader"></div>
		</div>
	</section>
	<section id="acctive-posts" class="sections">
		<h1 id="acctive-posts-h1"></h1>
		<div id="acctive-postsList">
			<div class="loader"></div>
		</div>
	</section>
	<section id="tops" class="sections">
		<h1 id="tops-h1"></h1>
		<div id="topsList">
			<div class="loader"></div>
		</div>
	</section>



	<iframe id="iframe" scrolling="no" frameBorder="0" src="https://chatbothackheroes.pythonanywhere.com/"></iframe>

	<button id="iframe-btn"><i class="fa-solid fa-comments fa-2x"></i></button>
	<button id="back-btn"><i class="fa-solid fa-backward fa-2x"></i></button>


	<div id="alert"><h3 id="alert-message"></h3><div id="alert-unload"></div></div>
	<script src="assets/scripts/loader.js"></script>
	<script src="assets/scripts/iframe.js"></script>
	<script src="assets/scripts/back.js"></script>
	<script src="assets/scripts/alert.js"></script>
	<script src="assets/scripts/date.js"></script>
	<script src="assets/scripts/reg.js"></script>
	<script type="module">




		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
		import { getDatabase, ref, set, child, get, update, remove, onValue, push, query, orderByChild, orderByValue, equalTo, limitToFirst, limitToLast } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-database.js";
		import { getAuth, createUserWithEmailAndPassword, setPersistence, signInWithEmailAndPassword, browserLocalPersistence, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js";

		const firebaseConfig = {
			apiKey: "AIzaSyBMkYcrZ_ow4Qvopu2vp9yD4DsXBw0NeJ4",
			authDomain: "hack-heroes-1.firebaseapp.com",
			projectId: "hack-heroes-1",
			storageBucket: "hack-heroes-1.appspot.com",
			messagingSenderId: "455270955105",
			appId: "1:455270955105:web:077e3d22e1223921245220",
			measurementId: "G-3NM9QQZTHJ"
		};

		const app = initializeApp(firebaseConfig);
		const database = getDatabase(app);
		const auth = getAuth();



		setPersistence(auth, browserLocalPersistence)
			.then(() => {
				return signInWithEmailAndPassword(auth, email, password);
			})
			.catch((error) => {
			});
















		const sections = document.querySelectorAll('.sections');

		function clear() {
			sections.forEach(box => {
				box.style.display = "none";
			})
		};
		window.addEventListener('load', (event) => {
			hash();
		});

		if (("onhashchange" in window) && navigator.userAgent.toLowerCase().indexOf('msie') == -1) {
			window.onhashchange = function () {
				hash();
			}
		};

		function hash() {
			var hash = window.location.hash.substring(1);
			clear();

			if (hash == "logowanie") {
				gotoLogin();
			} else if (hash == "tworzenie-konta") {
				gotoRegister();
			} else if (hash == "profil") {
				chceckLogin2();
				gotoProfile();
			} else if (hash == "zlecenia") {
				chceckLogin2();
				gotoPosts();
			} else if (hash == "aktywne-zlecenia") {
				chceckLogin2();
				gotoAcctivePosts();
			} else if (hash == "topka") {
				chceckLogin2();
				gotoTops();
			} else if (hash == "") {
				gotoMenu();
			} else {
				location.href = "";
				gotoMenu();
			}

			if (hash != "") {
				document.title = ("Just Help | " + (hash.charAt(0).toUpperCase() + hash.slice(1)));
			} else {
				document.title = ("Just Help | Wolontariusz");
			}
		};

		document.addEventListener("visibilitychange", function () {
			if (document.hidden) {
				document.title = ("Just Help | Wróć Do Nas!");
			}
			else {
				var hash = window.location.hash.substring(1);
				if (hash != "") {
					document.title = ("Just Help | " + (hash.charAt(0).toUpperCase() + hash.slice(1)));
				} else {
					document.title = ("Just Help | Wolontariusz");
				}
			}
		});

		function gotoMenu() {
			alert("info", "Wybierz!");
			document.getElementById("menu").style.display = "block";
		};
		function gotoProfile() {
			profil();
			document.getElementById("profile").style.display = "block";
		};
		function gotoPosts() {
			posts();
			document.getElementById("posts").style.display = "flex";
		};
		function gotoAcctivePosts() {
			postsAcctive();
			document.getElementById("acctive-posts").style.display = "flex";            //dodaj funkcję!
		};
		function gotoTops() {
			top();
			document.getElementById("tops").style.display = "flex";
		};
		function gotoLogin() {
			alert("info", "Zaloguj się!");
			document.getElementById("loginForm").style.display = "block";
			document.getElementById("login-email").focus();
		};
		function gotoRegister() {
			alert("info", "Utwórz konto!");
			document.getElementById("registerForm").style.display = "block";
			document.getElementById("register-username").focus();
		};
		document.getElementById("register").addEventListener("click", function (event) {
			register();
		});
		document.getElementById("login").addEventListener("click", function (event) {
			login();
		});
		document.getElementById("log").addEventListener("click", function (event) {
			chceckLogin();
		});
		document.getElementById("log").addEventListener("keyup", ({ key }) => {
			if (key === "Enter") {
				chceckLogin();
			}
		})
		document.getElementById("logout").addEventListener("click", function (event) {
			logout();
		});

		document.getElementById("login-password").addEventListener("keyup", ({ key }) => {
			if (key === "Enter") {
				login();
			}
		})
		document.getElementById("register-confirm-password").addEventListener("keyup", ({ key }) => {
			if (key === "Enter") {
				register();
			}
		})


		function register() {
			alert("info", "Sprawdzam!")
			const username = document.getElementById("register-username");
			const email = document.getElementById("register-email");
			const password = document.getElementById("register-password");
			const confirmpassword = document.getElementById("register-confirm-password");

			if (validate_username(username) == false) {
				username.value = "";
				username.focus();
				alert("error", "Brak nazwy użytkownika!");
				return
			}
			if (validate_email(email) == false) {
				email.value = "";
				email.focus();
				alert("error", "Błędny email!");
				return
			}
			if (validate_password(password) == false) {
				password.value = "";
				confirmpassword.value = "";
				password.focus();
				alert("error", "Hasło - min 7 znaków!");
				return
			}
			if (validate_confirmpassword(password, confirmpassword) == false) {
				password.value = "";
				confirmpassword.value = "";
				password.focus();
				alert("error", "Błędnie powtórzone hasło!");
				return
			}
			createUserWithEmailAndPassword(auth, email.value, password.value)
				.then(function () {

					const user = auth.currentUser
					const db = getDatabase();
					const dbRef = ref(db);

					get(child(dbRef, "volunteers/" + user.uid)).then((snapshot) => {
						set(ref(db, "volunteers/" + user.uid),
							{
								username: username.value,
								email: email.value,
								last_login: getDateString3(),
								account_create: getDateString(),
								points: 12
							})
							.then(() => {
								alert("succes", "Zarejestrowano!");
								location.href = "#logowanie";
							})
							.catch((error) => {
								password.value = "";
								confirmpassword.value = "";
								password.focus();
								alert("error", "Takie konto już istnieje!");
								return
							});
					})
				})
				.catch((error) => {
					password.value = "";
					confirmpassword.value = "";
					password.focus();
					alert("error", "Takie konto już istnieje!");
					return
				});
		};


		function validate_username(username) {
			var us = username.value;
			if (us.length > 0) {
				return true
			} else {
				return false
			}
		};
		function validate_email(email) {
			const expression = /^[^@]+@\w+(\.\w+)+\w$/
			if (expression.test(email.value) == true) {
				return true
			} else {
				return false
			}
		};

		function validate_password(password) {
			var pw = password.value;
			if (pw.length > 6) {
				return true
			} else {
				return false
			}
		};

		function validate_confirmpassword(password, confirmpassword) {
			if (password.value != confirmpassword.value) {
				return false
			} else {
				return true
			}
		};

		function login() {
			alert("info", "Sprawdzam!")
			const email = document.getElementById("login-email");
			const password = document.getElementById("login-password");

			signInWithEmailAndPassword(auth, email.value, password.value)
				.then(function () {

					const user = auth.currentUser
					const db = getDatabase();
					const dbRef = ref(db);

					get(child(dbRef, "volunteers/" + user.uid)).then((snapshot) => {
						if (snapshot.exists()) {
							update(ref(db, "volunteers/" + user.uid),
								{
									last_login: getDateString3(),
								})
								.then(() => {
									chceckLogin();
								})
								.catch((error) => {
									password.value = "";
									password.focus();
									alert("error", "Błędne dane logowania!");
									return
								});
						} else {
							alert("warning", "Wykryto złe konto!")
							silentlogout();
						};
					})
				})
				.catch((error) => {
					password.value = "";
					password.focus();
					alert("error", "Błędne dane logowania!");
					return
				});
		};


		function logout() {
			const auth = getAuth();
			signOut(auth).then(() => {
				location.replace('index.html');
			}).catch((error) => {
				alert("error", "Błąd wylogowywania!");
			});
		}

		function silentlogout() {
			const auth = getAuth();
			signOut(auth).then(() => {
				alert("info", "Zaloguj się!");
				location.href = "#logowanie";
			}).catch((error) => {
				alert("error", "Błąd wylogowywania!");
			});
		}







		function profil() {
			const db = getDatabase();
			onAuthStateChanged(auth, (user) => {
				if (user) {
					const uid = user.uid;
					const userRef = ref(db, "volunteers/" + uid);

					onValue(userRef, (snapshot) => {
						if (snapshot.exists()) {
							document.getElementById("profile-username").innerHTML = snapshot.val().username;
							document.getElementById("profile-points").innerHTML = snapshot.val().points;
							document.getElementById("profile-email").innerHTML = snapshot.val().email;
							document.getElementById("profile-account-create").innerHTML = snapshot.val().account_create;
						} else {
							alert("warning", "Wykryto złe konto!")
							silentlogout();
						}
					});
				} else {
					silentlogout();
				}
			});
		};


		function chceckLogin() {
			const db = getDatabase();
			onAuthStateChanged(auth, (user) => {
				if (user) {
					const uid = user.uid;
					const emailRef = ref(db, 'volunteers/' + uid + '/email');
					onValue(emailRef, (snapshot) => {
						if (snapshot.exists()) {
							alert("succes", "Zalogowano!");
							location.href = "#profil";
						} else {
							alert("info", "Wykryto inne konto - wylogowano!")
							silentlogout();
						};
					});
				} else {
					alert("info", "Zaloguj się!");
					location.href = "#logowanie";
				}
			});
		}

		function chceckLogin2() {
			const db = getDatabase();
			onAuthStateChanged(auth, (user) => {
				if (user) {
					const uid = user.uid;
					const emailRef = ref(db, "volunteers/" + uid + "/email");
					onValue(emailRef, (snapshot) => {
						if (snapshot.exists()) {
						} else {
							silentlogout();
						};
					});
				} else {
					location.href = "#logowanie";
				}
			});
		}


























		function posts() {
			onAuthStateChanged(auth, (user) => {
				if (user) {
					const db = getDatabase();
					const postsUidRef = ref(db, "posts");
					const posts = document.getElementById("postsList");
					var i = 1;
					onValue(postsUidRef, (snapshot) => {
						posts.innerHTML = "";
						document.getElementById("posts-h1").innerHTML = "Aktualne zlecenia:";
						snapshot.forEach((childSnapshot) => {
							const userId = childSnapshot.key;
							var postsRef = query(ref(db, "posts/" + userId), orderByChild("accept"), equalTo(false));

							onValue(postsRef, (snapshot) => {
								const count = snapshot.size;
								if (count == 0) {
									alert("info", "Brak aktualnych zleceń!");
									posts.innerHTML = `<div class='none'>Brak</div>`;
								} else {
									snapshot.forEach((childSnapshot) => {
										const postId = childSnapshot.key;
										const postIdRef = ref(db, "posts/" + userId + "/" + postId);


										var author = "";
										var title = "";
										var create = "";
										var description = "";
										var city = "";
										var address = "";
										var accept = "";

										onValue(postIdRef, (snapshot) => {
											if (snapshot.exists()) {
												author = snapshot.val().author;
												create = snapshot.val().create;
												title = snapshot.val().title;
												description = snapshot.val().description;
												city = snapshot.val().city;
												address = snapshot.val().address;
												accept = snapshot.val().accept;
											};
										});
										if (accept == false) {

											let div = document.createElement("div");

											div.id = "post-" + i;
											div.innerHTML = `${city} <br/> ${title} <br/> ${description} <br/> ${author} <br/> ${address} <br/> tel. -ukryty- <br/> ${create} <br/>`;
											div.className = "post";
											document.getElementById("postsList").appendChild(div);

											let btn2 = document.createElement("button");
											btn2.innerHTML = "Przyjmij zlecenie";
											btn2.id = `btn3-${i}`;
											btn2.addEventListener("click", acceptPost);
											document.getElementById("post-" + i).appendChild(btn2);
										};
										i++;
									});
								};
							});
						});
					});
				};
			});
		};

		function acceptPost() {
			document.getElementById("postsList").removeChild(this.closest("div"));
			var id = this.closest("button").id;
			var i = id.substring(id.indexOf('-')).replace('-', '');
			postAccept(i);
		}

		function postAccept(i) {
			onAuthStateChanged(auth, (user) => {
				if (user) {
					const user = auth.currentUser;
					const thisuserID = user.uid;
					const db = getDatabase();
					const postsUidRef = ref(db, "posts");
					onValue(postsUidRef, (snapshot) => {
						snapshot.forEach((childSnapshot) => {
							const userId = childSnapshot.key;
							//var postsRef = query(ref(db, "posts/" + userId), orderByChild("accept"), equalTo(thisuserID));
							var postsRef = ref(db, "posts/" + userId);


							onValue(postsRef, (snapshot) => {
								snapshot.forEach((childSnapshot) => {
									const postId = childSnapshot.key;
									const postIdRef = ref(db, "posts/" + userId + "/" + postId);

									update(postIdRef, {
										accept: thisuserID
									})
										.then(() => {
											alert("succes", "Aktywowałeś nowe zlecenie!");
											location.href = "#aktywne-zlecenia";
										});
								});
							});
						});
					});
				};
			});
		};







		function postsAcctive() {
			onAuthStateChanged(auth, (user) => {
				if (user) {
					const user = auth.currentUser;
					const thisuserID = user.uid;
					const db = getDatabase();
					const postsUidRef = ref(db, "posts");
					const posts = document.getElementById("acctive-postsList");
					var i = 1;
					onValue(postsUidRef, (snapshot) => {
						posts.innerHTML = "";
						document.getElementById("acctive-posts-h1").innerHTML = "Aktywne zlecenia:";
						snapshot.forEach((childSnapshot) => {
							const userId = childSnapshot.key;
							var postsRef = ref(db, "posts/" + userId);

							onValue(postsRef, (snapshot) => {
								snapshot.forEach((childSnapshot) => {
									const postId = childSnapshot.key;
									const postIdRef = ref(db, "posts/" + userId + "/" + postId);


									var author = "";
									var title = "";
									var create = "";
									var description = "";
									var city = "";
									var address = "";
									var accept = "";
									var phone = "";

									onValue(postIdRef, (snapshot) => {
										if (snapshot.exists()) {
											author = snapshot.val().author;
											create = snapshot.val().create;
											title = snapshot.val().title;
											description = snapshot.val().description;
											city = snapshot.val().city;
											address = snapshot.val().address;
											accept = snapshot.val().accept;
											phone = snapshot.val().phone;
										};
									});
									if (accept == thisuserID) {
										let div2 = document.createElement("div");

										div2.id = "post-" + i;
										div2.innerHTML = `${city} <br/> ${title} <br/> ${description} <br/> ${author} <br/> ${address} <br/> tel. ${phone} <br/> ${create} <br/>`;
										div2.className = "post";
										document.getElementById("acctive-postsList").appendChild(div2);
									} else {
										alert("warning", "Brak aktywnych zleceń!")
									}
									i++;
								});
							});
						});
					});
				};
			});
		};






































		function top() {
			onAuthStateChanged(auth, (user) => {
				if (user) {
					const db = getDatabase();
					const topsUidRef = query(ref(db, "volunteers"), orderByChild("points"), limitToFirst(10));
					const tops = document.getElementById("topsList");
					onValue(topsUidRef, (snapshot) => {
						tops.innerHTML = "";
						document.getElementById("tops-h1").innerHTML = "Top 10";
						var i = snapshot.size;
						snapshot.forEach((childSnapshot) => {
							const userId = childSnapshot.key;
							var topsRef = ref(db, 'volunteers/' + userId);

							var username2 = "";
							var points2 = "";
							var create2 = "";

							onValue(topsRef, (snapshot) => {
								if (snapshot.exists()) {
									username2 = snapshot.val().username;
									points2 = snapshot.val().points;
									create2 = snapshot.val().account_create;
								};

							});
							let div3 = document.createElement("div");

							div3.id = "top-" + i;
							div3.innerHTML = `<div>${i}. ${username2} ${create2}</div> <div><i class="fa-solid fa-fire-flame-curved points"></i>${points2}</div>`;
							div3.className = "top";
							document.getElementById("topsList").appendChild(div3);
							i--;
						});
					});
				};
			});
		};


	</script>

</body>
</html>